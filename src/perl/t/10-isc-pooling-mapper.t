use strict;
use warnings;
use Test::More tests => 5;

use wtsi_clarity::epp::isc::pooling::pooling_by_8_plex;
use wtsi_clarity::epp::isc::pooling::pooling_by_16_plex;

use_ok('wtsi_clarity::isc::pooling::mapper', 'can use ISC Pooling mapper');

local $ENV{'WTSI_CLARITY_HOME'}= q[t/data/config];
local $ENV{'WTSICLARITY_WEBCACHE_DIR'} = 't/data/isc/pooling/mapper';

{ # tests mapping for 1 plate with 8 plex
  my @container_ids = ('27-1');
  my $pooling_strategy = wtsi_clarity::epp::isc::pooling::pooling_by_8_plex->new();
  my $mapper = wtsi_clarity::isc::pooling::mapper->new(
    container_ids       => \@container_ids,
    pooling_strategy    => $pooling_strategy
  );

  isa_ok( $mapper, 'wtsi_clarity::isc::pooling::mapper');

  my $expected_mapping = { '27-1' => {
        'A:1' => 'A:1',
        'B:1' => 'A:1',
        'C:1' => 'A:1',
        'D:1' => 'A:1',
        'E:1' => 'A:1',
        'F:1' => 'A:1',
        'G:1' => 'A:1',
        'H:1' => 'A:1',
        'A:2' => 'B:1',
        'B:2' => 'B:1',
        'C:2' => 'B:1',
        'D:2' => 'B:1',
        'E:2' => 'B:1',
        'F:2' => 'B:1',
        'G:2' => 'B:1',
        'H:2' => 'B:1',
        'A:3' => 'C:1',
        'B:3' => 'C:1',
        'C:3' => 'C:1',
        'D:3' => 'C:1',
        'E:3' => 'C:1',
        'F:3' => 'C:1',
        'G:3' => 'C:1',
        'H:3' => 'C:1',
        'A:4' => 'D:1',
        'B:4' => 'D:1',
        'C:4' => 'D:1',
        'D:4' => 'D:1',
        'E:4' => 'D:1',
        'F:4' => 'D:1',
        'G:4' => 'D:1',
        'H:4' => 'D:1',
        'A:5' => 'E:1',
        'B:5' => 'E:1',
        'C:5' => 'E:1',
        'D:5' => 'E:1',
        'E:5' => 'E:1',
        'F:5' => 'E:1',
        'G:5' => 'E:1',
        'H:5' => 'E:1',
        'A:6' => 'F:1',
        'B:6' => 'F:1',
        'C:6' => 'F:1',
        'D:6' => 'F:1',
        'E:6' => 'F:1',
        'F:6' => 'F:1',
        'G:6' => 'F:1',
        'H:6' => 'F:1',
        'A:7' => 'G:1',
        'B:7' => 'G:1',
        'C:7' => 'G:1',
        'D:7' => 'G:1',
        'E:7' => 'G:1',
        'F:7' => 'G:1',
        'G:7' => 'G:1',
        'H:7' => 'G:1',
        'A:8' => 'H:1',
        'B:8' => 'H:1',
        'C:8' => 'H:1',
        'D:8' => 'H:1',
        'E:8' => 'H:1',
        'F:8' => 'H:1',
        'G:8' => 'H:1',
        'H:8' => 'H:1',
        'A:9' => 'A:2',
        'B:9' => 'A:2',
        'C:9' => 'A:2',
        'D:9' => 'A:2',
        'E:9' => 'A:2',
        'F:9' => 'A:2',
        'G:9' => 'A:2',
        'H:9' => 'A:2',
        'A:10' => 'B:2',
        'B:10' => 'B:2',
        'C:10' => 'B:2',
        'D:10' => 'B:2',
        'E:10' => 'B:2',
        'F:10' => 'B:2',
        'G:10' => 'B:2',
        'H:10' => 'B:2',
        'A:11' => 'C:2',
        'B:11' => 'C:2',
        'C:11' => 'C:2',
        'D:11' => 'C:2',
        'E:11' => 'C:2',
        'F:11' => 'C:2',
        'G:11' => 'C:2',
        'H:11' => 'C:2',
        'A:12' => 'D:2',
        'B:12' => 'D:2',
        'C:12' => 'D:2',
        'D:12' => 'D:2',
        'E:12' => 'D:2',
        'F:12' => 'D:2',
        'G:12' => 'D:2',
        'H:12' => 'D:2',
    }
  };

  is_deeply($mapper->mapping, $expected_mapping, qq/Should return the correct mapping for the source container./);
}

{ # tests mapping for 4 plate with 8 plex
  my @container_ids = ('27-1', '27-2', '27-3', '27-4');
  my $pooling_strategy = wtsi_clarity::epp::isc::pooling::pooling_by_8_plex->new();
  my $mapper = wtsi_clarity::isc::pooling::mapper->new(
    container_ids => \@container_ids,
    pooling_strategy    => $pooling_strategy
  );

  my $expected_mapping = { 
    '27-1' => {
        'A:1' => 'A:1',
        'B:1' => 'A:1',
        'C:1' => 'A:1',
        'D:1' => 'A:1',
        'E:1' => 'A:1',
        'F:1' => 'A:1',
        'G:1' => 'A:1',
        'H:1' => 'A:1',
        'A:2' => 'B:1',
        'B:2' => 'B:1',
        'C:2' => 'B:1',
        'D:2' => 'B:1',
        'E:2' => 'B:1',
        'F:2' => 'B:1',
        'G:2' => 'B:1',
        'H:2' => 'B:1',
        'A:3' => 'C:1',
        'B:3' => 'C:1',
        'C:3' => 'C:1',
        'D:3' => 'C:1',
        'E:3' => 'C:1',
        'F:3' => 'C:1',
        'G:3' => 'C:1',
        'H:3' => 'C:1',
        'A:4' => 'D:1',
        'B:4' => 'D:1',
        'C:4' => 'D:1',
        'D:4' => 'D:1',
        'E:4' => 'D:1',
        'F:4' => 'D:1',
        'G:4' => 'D:1',
        'H:4' => 'D:1',
        'A:5' => 'E:1',
        'B:5' => 'E:1',
        'C:5' => 'E:1',
        'D:5' => 'E:1',
        'E:5' => 'E:1',
        'F:5' => 'E:1',
        'G:5' => 'E:1',
        'H:5' => 'E:1',
        'A:6' => 'F:1',
        'B:6' => 'F:1',
        'C:6' => 'F:1',
        'D:6' => 'F:1',
        'E:6' => 'F:1',
        'F:6' => 'F:1',
        'G:6' => 'F:1',
        'H:6' => 'F:1',
        'A:7' => 'G:1',
        'B:7' => 'G:1',
        'C:7' => 'G:1',
        'D:7' => 'G:1',
        'E:7' => 'G:1',
        'F:7' => 'G:1',
        'G:7' => 'G:1',
        'H:7' => 'G:1',
        'A:8' => 'H:1',
        'B:8' => 'H:1',
        'C:8' => 'H:1',
        'D:8' => 'H:1',
        'E:8' => 'H:1',
        'F:8' => 'H:1',
        'G:8' => 'H:1',
        'H:8' => 'H:1',
        'A:9' => 'A:2',
        'B:9' => 'A:2',
        'C:9' => 'A:2',
        'D:9' => 'A:2',
        'E:9' => 'A:2',
        'F:9' => 'A:2',
        'G:9' => 'A:2',
        'H:9' => 'A:2',
        'A:10' => 'B:2',
        'B:10' => 'B:2',
        'C:10' => 'B:2',
        'D:10' => 'B:2',
        'E:10' => 'B:2',
        'F:10' => 'B:2',
        'G:10' => 'B:2',
        'H:10' => 'B:2',
        'A:11' => 'C:2',
        'B:11' => 'C:2',
        'C:11' => 'C:2',
        'D:11' => 'C:2',
        'E:11' => 'C:2',
        'F:11' => 'C:2',
        'G:11' => 'C:2',
        'H:11' => 'C:2',
        'A:12' => 'D:2',
        'B:12' => 'D:2',
        'C:12' => 'D:2',
        'D:12' => 'D:2',
        'E:12' => 'D:2',
        'F:12' => 'D:2',
        'G:12' => 'D:2',
        'H:12' => 'D:2',
    },
    '27-2' => {
        'A:1' => 'E:2',
        'B:1' => 'E:2',
        'C:1' => 'E:2',
        'D:1' => 'E:2',
        'E:1' => 'E:2',
        'F:1' => 'E:2',
        'G:1' => 'E:2',
        'H:1' => 'E:2',
        'A:2' => 'F:2',
        'B:2' => 'F:2',
        'C:2' => 'F:2',
        'D:2' => 'F:2',
        'E:2' => 'F:2',
        'F:2' => 'F:2',
        'G:2' => 'F:2',
        'H:2' => 'F:2',
        'A:3' => 'G:2',
        'B:3' => 'G:2',
        'C:3' => 'G:2',
        'D:3' => 'G:2',
        'E:3' => 'G:2',
        'F:3' => 'G:2',
        'G:3' => 'G:2',
        'H:3' => 'G:2',
        'A:4' => 'H:2',
        'B:4' => 'H:2',
        'C:4' => 'H:2',
        'D:4' => 'H:2',
        'E:4' => 'H:2',
        'F:4' => 'H:2',
        'G:4' => 'H:2',
        'H:4' => 'H:2',
        'A:5' => 'A:3',
        'B:5' => 'A:3',
        'C:5' => 'A:3',
        'D:5' => 'A:3',
        'E:5' => 'A:3',
        'F:5' => 'A:3',
        'G:5' => 'A:3',
        'H:5' => 'A:3',
        'A:6' => 'B:3',
        'B:6' => 'B:3',
        'C:6' => 'B:3',
        'D:6' => 'B:3',
        'E:6' => 'B:3',
        'F:6' => 'B:3',
        'G:6' => 'B:3',
        'H:6' => 'B:3',
        'A:7' => 'C:3',
        'B:7' => 'C:3',
        'C:7' => 'C:3',
        'D:7' => 'C:3',
        'E:7' => 'C:3',
        'F:7' => 'C:3',
        'G:7' => 'C:3',
        'H:7' => 'C:3',
        'A:8' => 'D:3',
        'B:8' => 'D:3',
        'C:8' => 'D:3',
        'D:8' => 'D:3',
        'E:8' => 'D:3',
        'F:8' => 'D:3',
        'G:8' => 'D:3',
        'H:8' => 'D:3',
        'A:9' => 'E:3',
        'B:9' => 'E:3',
        'C:9' => 'E:3',
        'D:9' => 'E:3',
        'E:9' => 'E:3',
        'F:9' => 'E:3',
        'G:9' => 'E:3',
        'H:9' => 'E:3',
        'A:10' => 'F:3',
        'B:10' => 'F:3',
        'C:10' => 'F:3',
        'D:10' => 'F:3',
        'E:10' => 'F:3',
        'F:10' => 'F:3',
        'G:10' => 'F:3',
        'H:10' => 'F:3',
        'A:11' => 'G:3',
        'B:11' => 'G:3',
        'C:11' => 'G:3',
        'D:11' => 'G:3',
        'E:11' => 'G:3',
        'F:11' => 'G:3',
        'G:11' => 'G:3',
        'H:11' => 'G:3',
        'A:12' => 'H:3',
        'B:12' => 'H:3',
        'C:12' => 'H:3',
        'D:12' => 'H:3',
        'E:12' => 'H:3',
        'F:12' => 'H:3',
        'G:12' => 'H:3',
        'H:12' => 'H:3',
    },
    '27-3' => {
        'A:1' => 'A:4',
        'B:1' => 'A:4',
        'C:1' => 'A:4',
        'D:1' => 'A:4',
        'E:1' => 'A:4',
        'F:1' => 'A:4',
        'G:1' => 'A:4',
        'H:1' => 'A:4',
        'A:2' => 'B:4',
        'B:2' => 'B:4',
        'C:2' => 'B:4',
        'D:2' => 'B:4',
        'E:2' => 'B:4',
        'F:2' => 'B:4',
        'G:2' => 'B:4',
        'H:2' => 'B:4',
        'A:3' => 'C:4',
        'B:3' => 'C:4',
        'C:3' => 'C:4',
        'D:3' => 'C:4',
        'E:3' => 'C:4',
        'F:3' => 'C:4',
        'G:3' => 'C:4',
        'H:3' => 'C:4',
        'A:4' => 'D:4',
        'B:4' => 'D:4',
        'C:4' => 'D:4',
        'D:4' => 'D:4',
        'E:4' => 'D:4',
        'F:4' => 'D:4',
        'G:4' => 'D:4',
        'H:4' => 'D:4',
        'A:5' => 'E:4',
        'B:5' => 'E:4',
        'C:5' => 'E:4',
        'D:5' => 'E:4',
        'E:5' => 'E:4',
        'F:5' => 'E:4',
        'G:5' => 'E:4',
        'H:5' => 'E:4',
        'A:6' => 'F:4',
        'B:6' => 'F:4',
        'C:6' => 'F:4',
        'D:6' => 'F:4',
        'E:6' => 'F:4',
        'F:6' => 'F:4',
        'G:6' => 'F:4',
        'H:6' => 'F:4',
        'A:7' => 'G:4',
        'B:7' => 'G:4',
        'C:7' => 'G:4',
        'D:7' => 'G:4',
        'E:7' => 'G:4',
        'F:7' => 'G:4',
        'G:7' => 'G:4',
        'H:7' => 'G:4',
        'A:8' => 'H:4',
        'B:8' => 'H:4',
        'C:8' => 'H:4',
        'D:8' => 'H:4',
        'E:8' => 'H:4',
        'F:8' => 'H:4',
        'G:8' => 'H:4',
        'H:8' => 'H:4',
        'A:9' => 'A:5',
        'B:9' => 'A:5',
        'C:9' => 'A:5',
        'D:9' => 'A:5',
        'E:9' => 'A:5',
        'F:9' => 'A:5',
        'G:9' => 'A:5',
        'H:9' => 'A:5',
        'A:10' => 'B:5',
        'B:10' => 'B:5',
        'C:10' => 'B:5',
        'D:10' => 'B:5',
        'E:10' => 'B:5',
        'F:10' => 'B:5',
        'G:10' => 'B:5',
        'H:10' => 'B:5',
        'A:11' => 'C:5',
        'B:11' => 'C:5',
        'C:11' => 'C:5',
        'D:11' => 'C:5',
        'E:11' => 'C:5',
        'F:11' => 'C:5',
        'G:11' => 'C:5',
        'H:11' => 'C:5',
        'A:12' => 'D:5',
        'B:12' => 'D:5',
        'C:12' => 'D:5',
        'D:12' => 'D:5',
        'E:12' => 'D:5',
        'F:12' => 'D:5',
        'G:12' => 'D:5',
        'H:12' => 'D:5',
    },
    '27-4' => {
        'A:1' => 'E:5',
        'B:1' => 'E:5',
        'C:1' => 'E:5',
        'D:1' => 'E:5',
        'E:1' => 'E:5',
        'F:1' => 'E:5',
        'G:1' => 'E:5',
        'H:1' => 'E:5',
        'A:2' => 'F:5',
        'B:2' => 'F:5',
        'C:2' => 'F:5',
        'D:2' => 'F:5',
        'E:2' => 'F:5',
        'F:2' => 'F:5',
        'G:2' => 'F:5',
        'H:2' => 'F:5',
        'A:3' => 'G:5',
        'B:3' => 'G:5',
        'C:3' => 'G:5',
        'D:3' => 'G:5',
        'E:3' => 'G:5',
        'F:3' => 'G:5',
        'G:3' => 'G:5',
        'H:3' => 'G:5',
        'A:4' => 'H:5',
        'B:4' => 'H:5',
        'C:4' => 'H:5',
        'D:4' => 'H:5',
        'E:4' => 'H:5',
        'F:4' => 'H:5',
        'G:4' => 'H:5',
        'H:4' => 'H:5',
        'A:5' => 'A:6',
        'B:5' => 'A:6',
        'C:5' => 'A:6',
        'D:5' => 'A:6',
        'E:5' => 'A:6',
        'F:5' => 'A:6',
        'G:5' => 'A:6',
        'H:5' => 'A:6',
        'A:6' => 'B:6',
        'B:6' => 'B:6',
        'C:6' => 'B:6',
        'D:6' => 'B:6',
        'E:6' => 'B:6',
        'F:6' => 'B:6',
        'G:6' => 'B:6',
        'H:6' => 'B:6',
        'A:7' => 'C:6',
        'B:7' => 'C:6',
        'C:7' => 'C:6',
        'D:7' => 'C:6',
        'E:7' => 'C:6',
        'F:7' => 'C:6',
        'G:7' => 'C:6',
        'H:7' => 'C:6',
        'A:8' => 'D:6',
        'B:8' => 'D:6',
        'C:8' => 'D:6',
        'D:8' => 'D:6',
        'E:8' => 'D:6',
        'F:8' => 'D:6',
        'G:8' => 'D:6',
        'H:8' => 'D:6',
        'A:9' => 'E:6',
        'B:9' => 'E:6',
        'C:9' => 'E:6',
        'D:9' => 'E:6',
        'E:9' => 'E:6',
        'F:9' => 'E:6',
        'G:9' => 'E:6',
        'H:9' => 'E:6',
        'A:10' => 'F:6',
        'B:10' => 'F:6',
        'C:10' => 'F:6',
        'D:10' => 'F:6',
        'E:10' => 'F:6',
        'F:10' => 'F:6',
        'G:10' => 'F:6',
        'H:10' => 'F:6',
        'A:11' => 'G:6',
        'B:11' => 'G:6',
        'C:11' => 'G:6',
        'D:11' => 'G:6',
        'E:11' => 'G:6',
        'F:11' => 'G:6',
        'G:11' => 'G:6',
        'H:11' => 'G:6',
        'A:12' => 'H:6',
        'B:12' => 'H:6',
        'C:12' => 'H:6',
        'D:12' => 'H:6',
        'E:12' => 'H:6',
        'F:12' => 'H:6',
        'G:12' => 'H:6',
        'H:12' => 'H:6',
    }
  };

  is_deeply($mapper->mapping, $expected_mapping, qq/Should return the correct mapping for the source container./);
}

{ # tests mapping for 1 plate with 8 plex
  my @container_ids = ('27-1');
  my $pooling_strategy = wtsi_clarity::epp::isc::pooling::pooling_by_16_plex->new();
  my $mapper = wtsi_clarity::isc::pooling::mapper->new(
    container_ids       => \@container_ids,
    pooling_strategy    => $pooling_strategy
  );

  my $expected_mapping = { '27-1' => {
        'A:1' => 'A:1',
        'B:1' => 'A:1',
        'C:1' => 'A:1',
        'D:1' => 'A:1',
        'E:1' => 'A:1',
        'F:1' => 'A:1',
        'G:1' => 'A:1',
        'H:1' => 'A:1',
        'A:2' => 'A:1',
        'B:2' => 'A:1',
        'C:2' => 'A:1',
        'D:2' => 'A:1',
        'E:2' => 'A:1',
        'F:2' => 'A:1',
        'G:2' => 'A:1',
        'H:2' => 'A:1',
        'A:3' => 'B:1',
        'B:3' => 'B:1',
        'C:3' => 'B:1',
        'D:3' => 'B:1',
        'E:3' => 'B:1',
        'F:3' => 'B:1',
        'G:3' => 'B:1',
        'H:3' => 'B:1',
        'A:4' => 'B:1',
        'B:4' => 'B:1',
        'C:4' => 'B:1',
        'D:4' => 'B:1',
        'E:4' => 'B:1',
        'F:4' => 'B:1',
        'G:4' => 'B:1',
        'H:4' => 'B:1',
        'A:5' => 'C:1',
        'B:5' => 'C:1',
        'C:5' => 'C:1',
        'D:5' => 'C:1',
        'E:5' => 'C:1',
        'F:5' => 'C:1',
        'G:5' => 'C:1',
        'H:5' => 'C:1',
        'A:6' => 'C:1',
        'B:6' => 'C:1',
        'C:6' => 'C:1',
        'D:6' => 'C:1',
        'E:6' => 'C:1',
        'F:6' => 'C:1',
        'G:6' => 'C:1',
        'H:6' => 'C:1',
        'A:7' => 'D:1',
        'B:7' => 'D:1',
        'C:7' => 'D:1',
        'D:7' => 'D:1',
        'E:7' => 'D:1',
        'F:7' => 'D:1',
        'G:7' => 'D:1',
        'H:7' => 'D:1',
        'A:8' => 'D:1',
        'B:8' => 'D:1',
        'C:8' => 'D:1',
        'D:8' => 'D:1',
        'E:8' => 'D:1',
        'F:8' => 'D:1',
        'G:8' => 'D:1',
        'H:8' => 'D:1',
        'A:9' => 'E:1',
        'B:9' => 'E:1',
        'C:9' => 'E:1',
        'D:9' => 'E:1',
        'E:9' => 'E:1',
        'F:9' => 'E:1',
        'G:9' => 'E:1',
        'H:9' => 'E:1',
        'A:10' => 'E:1',
        'B:10' => 'E:1',
        'C:10' => 'E:1',
        'D:10' => 'E:1',
        'E:10' => 'E:1',
        'F:10' => 'E:1',
        'G:10' => 'E:1',
        'H:10' => 'E:1',
        'A:11' => 'F:1',
        'B:11' => 'F:1',
        'C:11' => 'F:1',
        'D:11' => 'F:1',
        'E:11' => 'F:1',
        'F:11' => 'F:1',
        'G:11' => 'F:1',
        'H:11' => 'F:1',
        'A:12' => 'F:1',
        'B:12' => 'F:1',
        'C:12' => 'F:1',
        'D:12' => 'F:1',
        'E:12' => 'F:1',
        'F:12' => 'F:1',
        'G:12' => 'F:1',
        'H:12' => 'F:1',
    }
  };

  is_deeply($mapper->mapping, $expected_mapping, qq/Should return the correct mapping for the source container./);
}

1;